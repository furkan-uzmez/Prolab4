<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toplu Taşıma Durakları Haritası</title>
    <style>
        #map {
            height: 600px;
            width: 70%;
            float: left;
        }
        
        .form-container {
            float: left;
            margin-left: 20px;
            width: 25%;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        .form-container form input,
        .form-container form button {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        
        .legend {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .legend-item {
            margin: 5px 0;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .green-dot {
            background-color: green;
            border-radius: 50%;
        }
        
        .red-dot {
            background-color: red;
            border-radius: 50%;
        }
        
        h1, h2 {
            margin-top: 0;
        }
        
        .coordinate-display {
            margin-top: 10px;
            font-weight: bold;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Toplu Taşıma Durakları</h1>
    <div class="clearfix">
        <div id="map"></div>
        <div class="form-container">
            <h2>Konum Bilgileri</h2>
            <form method="POST">
                <label for="baslangic_enlem">Başlangıç Enlemi:</label>
                <input type="text" name="baslangic_enlem" id="baslangic_enlem" value="{{ baslangic_enlem }}" required><br>
                
                <label for="baslangic_boylam">Başlangıç Boylamı:</label>
                <input type="text" name="baslangic_boylam" id="baslangic_boylam" value="{{ baslangic_boylam }}" required><br>
                
                <label for="hedef_enlem">Hedef Enlemi:</label>
                <input type="text" name="hedef_enlem" id="hedef_enlem" value="{{ hedef_enlem }}" required><br>
                
                <label for="hedef_boylam">Hedef Boylamı:</label>
                <input type="text" name="hedef_boylam" id="hedef_boylam" value="{{ hedef_boylam }}" required><br>
                
                <button type="submit">Konumları Göster</button>
            </form>
            
            {% if hata %}
                <p class="error">{{ hata }}</p>
            {% endif %}
            
            <div class="coordinate-display">
                <p>Tıklayarak Haritada Konum Seçin:</p>
                <p>Seçilen Konum: <span id="selected-coordinates">Henüz seçilmedi</span></p>
                <button id="set-start">Başlangıç Noktası Olarak Ayarla</button>
                <button id="set-destination">Hedef Noktası Olarak Ayarla</button>
            </div>
            
            <div class="legend">
                <h3>Durak Türleri</h3>
                <div class="legend-item">
                    <span class="legend-color green-dot"></span> Otobüs Durağı
                </div>
                <div class="legend-item">
                    <span class="legend-color red-dot"></span> Tramvay Durağı
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Durak verilerini Flask'tan gelen duraklar değişkeninden al
        const durakVerisi = {{ duraklar|tojson }};
        
        let map;
        let markers = [];
        let infoWindows = [];
        let baslangicMarker;
        let hedefMarker;
        let clickMarker;
        
        function initMap() {
            // Varsayılan merkez noktası veya form ile gönderilen konum
            const baslangicEnlem = {{ baslangic_enlem }};
            const baslangicBoylam = {{ baslangic_boylam }};
            
            const center = { 
                lat: baslangicEnlem, 
                lng: baslangicBoylam 
            };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: center,
                zoom: 13
            });
            
            // Tüm durakları haritada göster
            const bounds = new google.maps.LatLngBounds();
            
            durakVerisi.forEach(durak => {
                // Durak türüne göre işaretçi simgesini belirle
                const iconUrl = durak.type === 'bus' 
                    ? 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                    : 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';
                
                // Durak bilgi penceresi içeriği
                const contentString = `
                    <div style="min-width: 200px">
                        <h3>${durak.name}</h3>
                        <p>Tür: ${durak.type === 'bus' ? 'Otobüs' : 'Tramvay'}</p>
                        <p>Konum: ${durak.lat.toFixed(6)}, ${durak.lon.toFixed(6)}</p>
                    </div>
                `;
                
                // Bilgi penceresi oluştur
                const infoWindow = new google.maps.InfoWindow({
                    content: contentString
                });
                
                infoWindows.push(infoWindow);
                
                // İşaretçi oluştur
                const marker = new google.maps.Marker({
                    position: { lat: durak.lat, lng: durak.lon },
                    map: map,
                    title: durak.name,
                    icon: iconUrl
                });
                
                // İşaretçiye tıklama olayı ekle
                marker.addListener('click', () => {
                    // Açık olan tüm bilgi pencerelerini kapat
                    infoWindows.forEach(window => window.close());
                    
                    // Bu işaretçinin bilgi penceresini aç
                    infoWindow.open(map, marker);
                });
                
                markers.push(marker);
                bounds.extend(marker.getPosition());
            });
            
            // Başlangıç işaretçisi
            baslangicMarker = new google.maps.Marker({
                position: { lat: {{ baslangic_enlem }}, lng: {{ baslangic_boylam }} },
                map: map,
                title: 'Başlangıç Noktası',
                icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
            });
            
            // Hedef işaretçisi
            hedefMarker = new google.maps.Marker({
                position: { lat: {{ hedef_enlem }}, lng: {{ hedef_boylam }} },
                map: map,
                title: 'Hedef Noktası',
                icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
            });
            
            // Başlangıç ve hedef noktalarını bounds'a ekle
            bounds.extend(baslangicMarker.getPosition());
            bounds.extend(hedefMarker.getPosition());
            
            // Tüm işaretçileri harita görünümüne sığdır
            map.fitBounds(bounds);
            
            // Haritaya tıklanınca işaretçi koyma
            map.addListener('click', function(event) {
                placeClickMarker(event.latLng);
            });
            
            // Butonlara event listener ekle
            setupEventListeners();
        }
        
        function placeClickMarker(location) {
            // Önceki tıklama işaretçisini kaldır
            if (clickMarker) {
                clickMarker.setMap(null);
            }
            
            // Yeni tıklama işaretçisi oluştur
            clickMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png'
            });
            
            // Koordinatları göster
            document.getElementById('selected-coordinates').textContent = 
                location.lat().toFixed(6) + ', ' + location.lng().toFixed(6);
        }
        
        function setupEventListeners() {
            document.getElementById('set-start').addEventListener('click', function() {
                if (clickMarker) {
                    const pos = clickMarker.getPosition();
                    document.getElementById('baslangic_enlem').value = pos.lat().toFixed(6);
                    document.getElementById('baslangic_boylam').value = pos.lng().toFixed(6);
                    
                    baslangicMarker.setPosition(pos);
                }
            });
            
            document.getElementById('set-destination').addEventListener('click', function() {
                if (clickMarker) {
                    const pos = clickMarker.getPosition();
                    document.getElementById('hedef_enlem').value = pos.lat().toFixed(6);
                    document.getElementById('hedef_boylam').value = pos.lng().toFixed(6);
                    
                    hedefMarker.setPosition(pos);
                }
            });
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap" async defer></script>
</body>
</html>